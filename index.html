<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte des Antennes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 90vh; width: 100vw; }
    .button-group { margin: 10px; }
    .button-group button { margin-right: 5px; }
    .active { background: #0078A8; color: #fff; }
  </style>
</head>
<body>
  <div class="button-group">
    <button id="btnAntTout" class="active">Ant_tout</button>
    <button id="btnAnt3G">Ant3G</button>
    <button id="btnSunrise" class="active">Sunrise</button>
    <button id="btnSwisscom" class="active">Swisscom</button>
    <button id="btnSalt" class="active">Salt</button>
  </div>
  <div id="map"></div>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // URLs des fichiers GeoJSON
    const URLS = {
      Ant_tout: "https://raw.githubusercontent.com/AntenneCarte/G2/refs/heads/main/Ant_tout.json",
      Ant3G: "https://raw.githubusercontent.com/AntenneCarte/G2/refs/heads/main/Ant3G.json"
    };

    // Opérateurs à filtrer
    const OPERATORS = ["Sunrise", "Swisscom", "Salt"];

    let map = L.map('map').setView([46.8, 8.2], 8); // Centré sur la Suisse
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let currentData = "Ant_tout";
    let activeOperators = new Set(OPERATORS);
    let geojsonLayer = null;
    let dataCache = {};

    // Fonction pour déterminer l'opérateur à partir du champ 'station'
    function getOperator(station) {
      if (!station) return "";
      for (const op of OPERATORS) {
        if (station.toLowerCase().includes(op.toLowerCase())) return op;
      }
      return "";
    }

    // Fonction pour créer un marqueur avec popup
    function pointToLayer(feature, latlng) {
      const props = feature.properties || {};
      let popup = `<b>${props.station || ''}</b><br>`;
      popup += props.techno_fr ? `<b>Technologie:</b> ${props.techno_fr}<br>` : '';
      popup += props.power_fr ? `<b>Puissance:</b> ${props.power_fr}<br>` : '';
      popup += props.typ_fr ? `<b>Type:</b> ${props.typ_fr}<br>` : '';
      popup += props.bewilligung_fr ? `<b>Autorisation:</b> ${props.bewilligung_fr}<br>` : '';
      return L.circleMarker(latlng, {radius: 7, fillColor: "#0078A8", color: "#222", weight: 1, fillOpacity: 0.8}).bindPopup(popup);
    }

    // Fonction pour filtrer selon opérateur
    function filterFeature(feature) {
      const station = feature.properties?.station || "";
      const op = getOperator(station);
      return activeOperators.has(op);
    }

    // Fonction pour charger et afficher les données
    async function loadData(name) {
      if (!dataCache[name]) {
        const response = await fetch(URLS[name]);
        dataCache[name] = await response.json();
      }
      return dataCache[name];
    }

    // Fonction principale d'affichage
    async function updateMap() {
      const geojson = await loadData(currentData);
      if (geojsonLayer) map.removeLayer(geojsonLayer);
      geojsonLayer = L.geoJSON(geojson, {
        filter: filterFeature,
        pointToLayer: pointToLayer
      }).addTo(map);
      map.fitBounds(geojsonLayer.getBounds(), {maxZoom: 12});
    }

    // Gestion des boutons Ant_tout / Ant3G
    document.getElementById('btnAntTout').onclick = function() {
      currentData = "Ant_tout";
      document.getElementById('btnAntTout').classList.add('active');
      document.getElementById('btnAnt3G').classList.remove('active');
      updateMap();
    };
    document.getElementById('btnAnt3G').onclick = function() {
      currentData = "Ant3G";
      document.getElementById('btnAnt3G').classList.add('active');
      document.getElementById('btnAntTout').classList.remove('active');
      updateMap();
    };

    // Gestion des boutons opérateurs
    OPERATORS.forEach(op => {
      document.getElementById('btn' + op).onclick = function() {
        if (activeOperators.has(op)) {
          activeOperators.delete(op);
          this.classList.remove('active');
        } else {
          activeOperators.add(op);
          this.classList.add('active');
        }
        updateMap();
      };
    });

    // Initialisation
    updateMap();
  </script>
</body>
</html>
